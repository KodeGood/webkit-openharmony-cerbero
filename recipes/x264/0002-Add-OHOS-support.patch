From c767c1fc67f7e20601efaea4dfceb703b6b92b1a Mon Sep 17 00:00:00 2001
From: Jani Hautakangas <jani@kodegood.com>
Date: Tue, 7 Jan 2025 13:30:00 +0300
Subject: [PATCH] Add OHOS support

---
 Makefile  |  4 +++-
 configure | 11 ++++++++++-
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index c692d02..37710b1 100644
--- a/Makefile
+++ b/Makefile
@@ -398,7 +398,9 @@ ifneq ($(IMPLIBNAME),)
 	$(INSTALL) -m 755 $(SONAME) $(DESTDIR)$(bindir)
 	$(INSTALL) -m 644 $(IMPLIBNAME) $(DESTDIR)$(libdir)
 else ifneq ($(SONAME),)
-	ln -f -s $(SONAME) $(DESTDIR)$(libdir)/libx264.$(SOSUFFIX)
+	@if [ "$(SONAME_SYMLINK)" != "no" ]; then \
+		ln -f -s $(SONAME) $(DESTDIR)$(libdir)/libx264.$(SOSUFFIX); \
+	fi
 	$(INSTALL) -m 755 $(SONAME) $(DESTDIR)$(libdir)
 endif
 
diff --git a/configure b/configure
index 8308fd5..d502f0d 100755
--- a/configure
+++ b/configure
@@ -644,6 +644,11 @@ case $host_os in
         SYS="OPENBSD"
         libm="-lm"
         ;;
+    *linux-ohos*)
+        SYS="OHOS"
+        define HAVE_MALLOC_H
+        libm="-lm"
+        ;;
     *linux*)
         SYS="LINUX"
         define HAVE_MALLOC_H
@@ -1511,6 +1516,11 @@ if [ "$shared" = "yes" ]; then
         echo "SOSUFFIX=so" >> config.mak
         echo "SONAME=libx264.so.$API" >> config.mak
         echo "SOFLAGS=-shared -Wl,-h,\$(SONAME) $SOFLAGS" >> config.mak
+    elif [ "$SYS" = "OHOS" ]; then
+        echo "SOSUFFIX=so" >> config.mak
+        echo "SONAME=libx264.so" >> config.mak
+        echo "SONAME_SYMLINK=no" >> config.mak
+        echo "SOFLAGS=-shared -Wl,-soname,\$(SONAME) $SOFLAGS" >> config.mak
     else
         echo "SOSUFFIX=so" >> config.mak
         echo "SONAME=libx264.so.$API" >> config.mak
@@ -1581,4 +1591,3 @@ mkdir -p common/{aarch64,arm,mips,ppc,x86} encoder extras filters/video input ou
 
 echo
 echo "You can run 'make' or 'make fprofiled' now."
-
-- 
2.48.1

