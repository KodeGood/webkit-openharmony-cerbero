# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python

class Recipe(recipe.Recipe):
    name = 'wpewebkit'
    version = '2.50.0'
    stype = SourceType.TARBALL
    btype = BuildType.CMAKE
    url = f'https://wpewebkit.org/releases/wpewebkit-{version}.tar.xz'
    tarball_checksum = 'a9af62c5e18551b7386b7db864e8ba8156f219b8e6c639934bf6f3a567969922'
    deps = [
        'breakpad',
        'cairo',
        'freetype',
        'gettext',
        'gstreamer-1.0',
        'gst-plugins-base-1.0',
        'gst-plugins-good-1.0',
        'gst-plugins-bad-1.0',
        'harfbuzz',
        'icu',
        'libepoxy',
        'libgcrypt',
        'libjpeg-turbo',
        'libpng',
        'libsoup',
        'libtasn1',
        'libxslt',
        'libwebp',
        'libwpe',
        'openjpeg',
    ]
    # TODO: support accessibility woff2
    configure_options = '\
        -DPORT=WPE \
        -DUSE_GSTREAMER_GL=ON \
        -DUSE_WOFF2=OFF \
        -DENABLE_DOCUMENTATION=OFF \
        -DENABLE_INTROSPECTION=OFF \
        -DENABLE_JOURNALD_LOG=OFF \
        -DENABLE_BUBBLEWRAP_SANDBOX=OFF \
        -DENABLE_SPEECH_SYNTHESIS=OFF \
        -DENABLE_BREAKPAD=OFF \
        -DUSE_ATK=OFF \
        -DUSE_LCMS=OFF \
        -DUSE_AVIF=OFF \
        -DUSE_GBM=OFF \
        -DUSE_LIBDRM=OFF \
        -DUSE_JPEGXL=OFF \
        -DUSE_LIBBACKTRACE=OFF \
        -DUSE_SKIA_OPENTYPE_SVG=OFF \
        -DUSE_SYSPROF_CAPTURE=OFF \
        -DENABLE_WEBDRIVER=OFF \
        -DENABLE_WPE_PLATFORM=ON \
        -DENABLE_WPE_PLATFORM_DRM=OFF \
        -DENABLE_WPE_PLATFORM_WAYLAND=OFF \
        -DCMAKE_BUILD_TYPE=Release \
    '
    cmake_generator = 'ninja'

    files_libs = [
        'libWPEWebKit-2.0',
    ]

    files_misc = [
        'lib/wpe-webkit-2.0/injected-bundle/libWPEInjectedBundle.so'
    ]

    files_shared = [
        'share/wpe-webkit-2.0/inspector.gresource',
    ]

    files_devel = [
        'include/wpe-webkit-2.0',
        'lib/pkgconfig/wpe-platform-2.0.pc',
        'lib/pkgconfig/wpe-webkit-2.0.pc',
        'lib/pkgconfig/wpe-web-process-extension-2.0.pc'
    ]

    patches = [
        'wpewebkit/0001-Switch-TextUnderElementMode-to-braced-init.patch',
        'wpewebkit/0002-Avoid-capturing-structured-bindings.patch',
        'wpewebkit/0003-Fix-sentinel-warning.patch',
        'wpewebkit/0004-Use-aggregate-initialization-for-CompositeMode-to-fi.patch',
        'wpewebkit/0005-Provide-guarded-source_location-polyfill-for-toolcha.patch',
        'wpewebkit/0006-Relax-consteval-constexpr-for-StylePrimitiveNumeric-.patch',
        'wpewebkit/0007-Fix-dependent-type-qualifiers.patch',
        'wpewebkit/0008-WPEPlatform-Introduce-support-for-OpenHarmony-platfo.patch',
        'wpewebkit/0009-Create-unversioned-libWPEWebKit.patch',
        'wpewebkit/0010-Log-messages-to-the-HiLog.patch'
    ]

    def prepare(self):
        from os import path
        glib_compile_resources_path = \
            path.join(self.config.build_tools_prefix, 'bin', 'glib-compile-resources')
        self.configure_options += f' \
            -DICU_ROOT={self.config.prefix} \
            -DZLIB_ROOT={self.config.prefix} \
            -DFREETYPE_LIBRARY={self.config.prefix}/lib/libfreetype.so \
            -DFREETYPE_INCLUDE_DIR_ft2build={self.config.prefix}/include/freetype2 \
            -DFREETYPE_INCLUDE_DIR_freetype2={self.config.prefix}/include/freetype2 \
            -DGLIB_COMPILE_RESOURCES_EXECUTABLE={glib_compile_resources_path} \
            -DJPEG_LIBRARY={self.config.prefix}/lib/libjpeg.so \
            -DJPEG_INCLUDE_DIR={self.config.prefix}/include \
            -DPNG_LIBRARY={self.config.prefix}/lib/libpng.so \
            -DPNG_INCLUDE_DIR={self.config.prefix}/include \
            '
        if self.config.target_platform in (Platform.ANDROID):
            arch_src_name = self.config.target_arch
            if self.config.target_arch == Architecture.ARMv7:
                arch_src_name = 'arm'
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR=' + arch_src_name
            self.configure_options += ' -DANDROID=1'
            # Placeholder to allow enabling debug externally
            self.append_env('WEBKIT_DEBUG', '')
        if self.config.target_platform == Platform.OHOS:
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR=' + self.config.target_arch
            self.configure_options += ' -DOHOS=1'
            self.configure_options += ' -DWPE_PLATFORM_BUFFER_OHOS=1'
            self.configure_options += ' -DBREAKPAD_MINIDUMP_DIR=/data/storage/el2/base/files/'
            self.append_env('CXXFLAGS', '-std=c++20')
            self.append_env('CXXFLAGS', '-fexperimental-library')
            self.append_env('LDFLAGS', '-lintl')
        else:
            self.append_env('LDFLAGS', '-lrt')
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR=' + self.config.target_arch
